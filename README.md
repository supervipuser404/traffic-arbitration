# Traffic Arbitration

**Traffic Arbitration** — платформа для сбора, публикации и аукционного продвижения статей (и рекламных материалов) с поддержкой мультиязычных сервисов на Python и Go.

---

## Цели проекта

- Сбор, хранение, публикация и анализ контент-статей с разных источников.
- Гибкое администрирование и модерирование через административную панель.
- Мультиязычная архитектура: Python для веб-интерфейса и административных сервисов; Go — для высоконагруженных микросервисов (DSP, SSP, Bidder).
- Масштабируемость, поддержка мультиязычных пользователей, возможность дальнейшего расширения.

---

## Архитектура и структура репозитория

```text
traffic-arbitration/
│
├── python/
│   ├── traffic_arbitration/
│   │   ├── common/         # Общие утилиты и конфиг-лоадер
│   │   ├── web/            # FastAPI-приложение (user-интерфейс и админка)
│   │   ├── scrapper/       # Модуль сбора внешних статей
│   │   └── ...             # Другие сервисы/модули (по мере роста)
│   ├── tests/              # Тесты для Python-компонентов
│   ├── pyproject.toml      # Poetry/Pipenv конфиг
│   └── ...
│
├── go/
│   ├── ssp/                # Supply Side Platform сервис (Go)
│   ├── dsp/                # Demand Side Platform сервис (Go)
│   ├── bidder/             # Bidder/Аукцион (Go)
│   ├── pkg/                # Общие библиотеки (например, чтение конфигов)
│   ├── go.mod
│   └── ...
│
├── migrations/             # Миграции схемы БД (SQL-файлы)
├── config.tpl.yml          # Шаблон конфиг-файла
├── README.md
├── .gitignore
└── ...
````

---

## Ключевые решения и принципы

* **Разделение по языкам:**
  Весь код на Python и Go лежит в отдельных подпапках (`python/`, `go/`). Внутри — разделение по сервисам/компонентам.
* **Единая схема базы данных:**
  SQL-макеты и миграции лежат в `/migrations`, используются всеми сервисами.
  **Изменения схемы — только через миграции!**
* **Универсальный config.yml:**
  Единый YAML-конфиг лежит в корне проекта.
  Все сервисы читают его через свой loader (Python и Go), путь передаётся через переменную окружения `CONFIG_PATH` или ищется вверх по дереву.
* **Модели/структуры в сервисах генерируются автоматически:**
  Для Python — через [sqlacodegen](https://github.com/agronholm/sqlacodegen),
  для Go — через [xo](https://github.com/xo/xo) или [sqlc](https://github.com/kyleconroy/sqlc).
  Описания схемы **не дублируются вручную!**
* **Комментарии к коду — на русском; все логи, ошибки и сообщения — на английском.**

---

## Технологии

* **Python**: FastAPI, SQLAlchemy, Pydantic, Poetry, Alembic, PyTest
* **Go**: net/http, go-yaml, стандартные библиотеки, sqlc/xo, Docker
* **PostgreSQL**: основная БД
* **Docker** (Docker Compose): для локальной разработки и деплоя
* **Frontend** (планируется): SPA на Vue или React для админки

---

## Основные компоненты

* **Административная панель** (FastAPI + SPA, защищённая JWT-авторизацией)
* **Сборщик статей** (Python, модуль scrapper)
* **Web-интерфейс** (отдача статей пользователям)
* **DSP, SSP, Bidder** (Go-сервисы, взаимодействие с БД и друг с другом, участвуют в рекламном аукционе)

---

## Конфиг и миграции

* **config.yml** не хранится в git!
  Используйте `config.tpl.yml` как шаблон:

  * Скопируйте `cp config.tpl.yml config.yml`
  * Заполните вручную нужные поля (DB-пароли, секреты, настройки сервисов)
* **Путь к config.yml** можно задать через переменную окружения `CONFIG_PATH`,
  иначе loader ищет его вверх по директориям.
* **Миграции**: любая смена структуры БД — только через миграции из папки `/migrations`.
* **Генерация моделей**:

  * Для Python: `sqlacodegen postgresql://... > python/traffic_arbitration/common/models.py`
  * Для Go: `sqlc generate` или `xo ...` в папку с нужным сервисом

---

## Как стартовать проект (локально)

1. **Склонировать репозиторий**
2. **Создать `config.yml` на основе шаблона**
3. **Поднять PostgreSQL и применить миграции (из `/migrations`)**
4. **(Python) Установить Poetry, собрать окружение, установить зависимости**
5. **(Go) Инициализировать go.mod, собрать сервисы**
6. **Запустить сервисы (через Docker Compose или вручную)**

---

## Основные команды

* **Генерация моделей (Python):**

  ```sh
  poetry install
  poetry run sqlacodegen postgresql://user:pass@host:port/db > python/traffic_arbitration/common/models.py
  ```
* **Генерация моделей (Go):**

  ```sh
  cd go/
  sqlc generate
  # или xo pgsql://user:pass@host:port/db --out ssp/models
  ```
* **Миграции:**

  ```sh
  psql -U user -d db -f migrations/001_init.sql
  # либо через alembic, если используется
  ```
* **Запуск сервисов:**

  ```sh
  cd python/
  poetry run python -m traffic_arbitration.web.main
  cd ../go/ssp/
  go run main.go
  ```

---

## Документирование изменений схемы

* **Любое изменение схемы БД — только через новую миграцию!**
* **После изменения схемы — перегенерировать модели для всех языков.**
* **Не писать модели в Go/Python вручную — только через генераторы.**

---

## CI/CD, тесты и стандарты

* Все новые сервисы и компоненты должны иметь тесты (pytest для Python, testing для Go).
* Код проходит авто-форматирование (black/flake8 для Python, gofmt для Go).
* Логи, ошибки, сообщения — всегда на английском.
* Для внутреннего обсуждения и комментариев в коде — можно использовать русский язык.

---

## Контакты и документация

* Все вопросы, баги и предложения — через Issues или Wiki этого репозитория.
* Архитектурные схемы и документация (API, структура миграций, описания сервисов) — в Wiki.

---

**Этот README отражает целевую структуру и принципы развития Traffic Arbitration.**
Если ваш pull request или новый компонент не соответствует этим правилам — обсудите его с командой!

