# Traffic Arbitration

**Traffic Arbitration** — платформа для сбора, публикации и аукционного продвижения статей (и рекламных материалов) с
поддержкой мультиязычных сервисов на Python и Go.

---

## Цели проекта

* Сбор, хранение, публикация и анализ статей и рекламных материалов с разных источников.
* Удобное администрирование и модерирование через web-интерфейс и API.
* Архитектура: Python — административные и web-сервисы; Go — высоконагруженные микросервисы (SSP, DSP, Bidder).
* Масштабируемость, поддержка мультиязычности, удобное масштабирование команды.

---

## Архитектура и структура репозитория

```text
traffic-arbitration/
│
├── python/
│   ├── traffic_arbitration/
│   │   ├── common/           # Конфиг, утилиты, общие компоненты
│   │   ├── db/               # Подключение к БД, базовые запросы
│   │   ├── models/           # Модели SQLAlchemy: autogen_*.py (генерируются), custom_*.py (ручные расширения)
│   │   ├── scrapper/         # Модуль сбора и агрегации статей
│   │   └── web/              # FastAPI приложение: публичный API, админка, статика, шаблоны
│   ├── tests/                # Тесты для Python-компонентов
│   ├── pyproject.toml        # Poetry конфиг
│   └── ...
│
├── go/
│   ├── ssp/                  # Supply Side Platform (Go)
│   ├── dsp/                  # Demand Side Platform (Go)
│   ├── bidder/               # Auction/Bidder сервис (Go)
│   ├── pkg/
│   │   ├── config/           # Лоадер конфига (на Go)
│   │   └── models_autogen/   # Go-модели (генерируются sqlboiler)
│   ├── go.mod
│   └── ...
│
├── migrations/               # Миграции схемы БД (alembic/sql)
├── config.tpl.yml            # Шаблон конфига (образец)
├── README.md
└── ...
```

---

## Ключевые решения и принципы

* **Языки строго разделены:**
  Весь код на Python и Go лежит в отдельных папках (`python/`, `go/`).
  Внутри — разделение по сервисам, слоям, автоген/ручное.
* **Python-модели (SQLAlchemy) — источник истины для схемы.**
* **Alembic — единственный инструмент миграций.**
  Любые изменения схемы — только через alembic-макросы.
* **Единый config.yml (YAML) для всех языков:**
  Конфиг хранится вне git (используйте `config.tpl.yml` как шаблон).
  Путь ищется через переменную окружения `CONFIG_PATH` или вверх по дереву.
* **Генерация моделей полностью автоматизирована:**

    * Для Python: [sqlacodegen](https://github.com/agronholm/sqlacodegen)
      (в папку `models/autogen_*.py`, запрещено менять вручную!)
    * Для Go: [sqlboiler](https://github.com/volatiletech/sqlboiler)
      (в папку `pkg/models_autogen/`, запрещено менять вручную!)
    * Пользовательские расширения пишутся в отдельных файлах (`custom_*.py`, `custom_*.go`)
* **Комментарии к коду — на русском; все логи, сообщения, ошибки — на английском.**

---

## Технологии

* **Python:** FastAPI, SQLAlchemy, Pydantic, Poetry, Alembic, PyTest, sqlacodegen
* **Go:** net/http, go-yaml, sqlboiler, Docker, стандартные библиотеки
* **PostgreSQL** — основная БД
* **Docker (Compose)** — для локальной разработки и CI
* **Frontend** (в перспективе): SPA (React/Vue) для админки

---

## Основные компоненты

* **Админ-панель** (FastAPI + SPA)
* **Web API** (Python, отдача статей и статистики)
* **Скраппер** (Python)
* **SSP, DSP, Bidder** (Go)
* **Гибкая система миграций (Alembic)**

---

## Работа с конфигом и миграциями

* **config.yml** не хранится в git!
  Используйте `config.tpl.yml` как шаблон:

  ```
  cp config.tpl.yml config.yml
  ```

  Заполните вручную пароли, ключи и параметры окружения.
* **Путь к конфигу**: задавайте через `CONFIG_PATH` или положите рядом с сервисом.
* **Миграции**:
  Любые изменения БД — только через alembic (`python -m alembic revision --autogenerate -m "desc"`).

---

## Автоматическая генерация моделей

* **Для Python:**
  Используйте специальный скрипт автогена (см. `dev/gen_models.py`):

  ```
  poetry run python dev/gen_models.py
  ```

  Автоматически сгенерирует все модели в `models/autogen_models.py`.

* **Для Go:**
  После alembic-миграции запускайте генерацию:

  ```
  cd go/pkg
  sqlboiler psql --no-tests --output models_autogen
  ```

  (или используйте общий скрипт автогена, если настроен)

* **Ручные расширения и бизнес-логика** — только в отдельных файлах (`custom_*.py`, `custom_*.go`).

---

## Как стартовать проект

1. Клонируйте репозиторий
2. Создайте `config.yml` на основе `config.tpl.yml`
3. Поднимите PostgreSQL, примените миграции (через alembic)
4. Для Python:

    * Установите poetry, соберите окружение
    * Установите зависимости:

      ```
      poetry install
      ```
    * Примените миграции:

      ```
      poetry run alembic upgrade head
      ```
    * Сгенерируйте модели:

      ```
      poetry run python dev/gen_models.py
      ```
5. Для Go:

    * Проверьте/обновите go.mod
    * Сгенерируйте Go-модели (см. выше)
    * Соберите сервисы

---

## Основные команды

```sh
# Применить миграции
poetry run alembic upgrade head

# Генерировать Python-модели
poetry run python dev/gen_models.py

# Генерировать Go-модели (из go/pkg/)
sqlboiler psql --no-tests --output models_autogen

# Запустить FastAPI-сервис
poetry run python -m traffic_arbitration.web.main

# Запустить Go-сервис
cd go/ssp/ && go run main.go
```

---

## Требования к изменению схемы

* **Любые изменения схемы — только через alembic-макросы.**
* После изменения схемы — обязательно перегенерировать модели для Python и Go.
* **Ручное изменение автоген-моделей — запрещено.**
* Расширяйте и пишите бизнес-логику только в кастомных файлах.

---

## CI/CD, тесты и стандарты

* Для каждого нового сервиса — обязательны тесты (pytest для Python, testing для Go)
* Код форматируется автоматически (black/flake8, gofmt)
* Все логи и ошибки — на английском
* Для внутренних комментариев можно использовать русский язык

---

## Документация и поддержка

* Вопросы, баги, предложения — через Issues.
* Документация по архитектуре и API — в Wiki репозитория.
* Вся информация о миграциях, изменениях моделей — только в pull-requests и changelog.

---

**Этот README отражает актуальную целевую структуру и организацию проекта Traffic Arbitration.
Если ваш pull request не соответствует этим принципам — согласуйте изменения с командой!**
