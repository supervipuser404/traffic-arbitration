# Техническое задание на разработку Content Service

## 1\. Цель проекта

Создание высокопроизводительного сервиса для отдачи контента (статей) и тизерной рекламы с возможностью интеграции RTB и ML-ранжирования.

## 2\. Архитектура и Стек

-   **Backend:** Python (FastAPI) + SQLAlchemy (Async/Sync mix).
    
-   **Database:** PostgreSQL.
    
-   **Frontend:** Server Side Rendering (Jinja2) + jQuery + Custom JS.
    
-   **Cache:** In-memory caching (с поддержкой dataclass структур).
    

## 3\. Структура Страниц и Роутинг

### 3.1. Главная / Категория

-   **URL:** `/` и `/cat/{category}`
    
-   **Структура:** Хедер -> Бесконечная лента тизеров (Feed) -> Футер.
    
-   **Логика:** Адаптивная сетка тизеров (1-4 колонки).
    

### 3.2. Анонс (Preview)

-   **URL:** `/preview/{slug}`
    
-   **Структура:**
    
    1.  Хедер.
        
    2.  **Блок Анонса:**
        
        -   Слева: Заголовок + Крупная картинка (с блюр-фоном) + Кнопка "Читать далее".
            
        -   Справа: Сайдбар с тизерами (**S-блок**). Скрывается на ширине < 994px.
            
    3.  Бесконечная лента тизеров (**L-блок**).
        
    4.  Футер.
        

### 3.3. Статья (Article)

-   **URL:** `/article/{slug}`
    
-   **Структура:**
    
    1.  Хедер.
        
    2.  **Блок Контента:**
        
        -   Слева: Заголовок + Картинка + **Текст статьи**.
            
        -   Внутри текста: Врезки тизеров (**I-блок**) через каждые 2 "абзаца".
            
        -   Справа: Сайдбар с тизерами (**R-блок**). Высота зависит от длины статьи. Скрывается на ширине < 994px.
            
    3.  Бесконечная лента тизеров (**L-блок**).
        
    4.  Футер.
        

## 4\. Тизерная Система и API

### 4.1. Нейминг Виджетов

Используется строгий формат имени виджета (4 символа) для идентификации места на странице: `[Тип][Колонка][Ряд]`

-   **Тип (1 символ):**
    
    -   `l` — **L**ent (Лента). Основная сетка внизу.
        
    -   `s` — **S**idebar (Preview). Сайдбар на странице анонса (мелкие тизеры).
        
    -   `r` — **R**ight Column (Article). Сайдбар на странице статьи (крупные тизеры).
        
    -   `i` — **I**n-Article. Тизеры внутри текста статьи.
        
-   **Колонка (1 символ, hex):** Номер колонки (0-f). Для сайдбаров и i-блоков всегда `0`.
    
-   **Ряд (2 символа, hex, padded):** Номер ряда (00-ff).
    

_Примеры:_ `l000` (Лента, 1-я колонка, 1-й ряд), `l30a`, `s004`, `i002`.

### 4.2. Эндпойнт `/etc` (Тизеры)

Единая точка входа для получения контента всех виджетов на странице.

-   **Method:** `POST`
    
-   **Принцип "Единого Запроса":** При загрузке страницы фронтенд собирает все необходимые места (сайдбар + 1-й экран ленты + i-блоки) и делает **один** запрос. Это необходимо для корректного ML-ранжирования.
    
-   **Request (JSON):**
    
    -   `widgets`: Map `{ "widget_name": quantity }`.
        
    -   `uid`, `ip`, `ua`, `url`, `w`, `h`: Данные пользователя и устройства.
        
    -   `category`: Код текущей категории (для фильтрации) или null.
        
    -   `seen_ids_page`: Список ID тизеров, уже показанных в текущей сессии (JS).
        
    -   `seen_ids_long_term`: Список ID тизеров, показанных ранее (Cookie).
        
-   **Response (JSON):**
    
    -   `widgets`: Map `{ "widget_name": ArticlePreviewObject }`.
        
    -   `newly_served_ids`: Список ID, которые были выданы в этом ответе (для обновления Cookie).
        

### 4.3. Логика Дедупликации

1.  **В моменте:** Бэкенд гарантирует уникальность тизеров в рамках одного ответа.
    
2.  **На странице:** Фронтенд шлет `seen_ids_page`, бэкенд исключает их из выдачи.
    
3.  **Долгосрочная:** Фронтенд шлет `seen_ids_long_term` (Cookie). Бэкенд старается не показывать их.
    
    -   _Фолбэк:_ Если свежие тизеры закончились, бэкенд может отдать тизеры из `seen_ids_long_term`, сохраняя их исходный порядок.
        

## 5\. Логика Фронтенда

-   **Трекинг ссылок:** JS модифицирует ссылки тизеров, добавляя параметры `w` (ширина вьюпорта) и `ws` (имя виджета).
    
-   **Учет просмотров:** Используется `IntersectionObserver`. Просмотр засчитывается, если тизер виден на 50%. ID добавляется в `seen_ids_page`.
    
-   **Бесконечная прокрутка:** Реализована через `IntersectionObserver` или проверку скролла. Догрузка идет отдельными запросами к `/etc`. Лимит ленты — 100 рядов.
    

## 6\. Логика Бэкенда (Обработка текста)

-   **Парсинг статьи:** Текст статьи в БД хранится с разделителями `<br>`.
    
-   **Вставка I-блоков:**
    
    1.  Текст разбивается по `<br>`.
        
    2.  Формируются псевдо-абзацы (`div.article-paragraph`).
        
    3.  После каждого **2-го** абзаца вставляется плейсхолдер виджета `i0xx`.
        
    4.  Вставка не производится, если до конца текста остался 1 абзац.
