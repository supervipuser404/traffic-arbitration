Ответ был перепроверен и дополнен ключевыми деталями для максимального соответствия оригиналу.

### **Техническое задание на разработку новостного сайта "WorldWave" (Дополненная версия)**

---

#### **1. Общее описание**

Необходимо разработать фронтенд и бэкенд для новостного веб-сайта "WorldWave". Сайт представляет собой новостную витрину с динамической подгрузкой контента. Ключевыми особенностями являются сложная адаптивная сетка, система push-уведомлений через Firebase и нестандартная логика обработки кликов с перенаправлением.

---

#### **2. Стек технологий**

* **Фронтенд:** HTML5, CSS3, JavaScript (ES6+). Оригинал использует **jQuery 1.8.3**, однако для новой разработки рекомендуется нативный JS или легковесный фреймворк для управления состоянием и рендерингом.
* **Бэкенд:** Любой современный серверный язык (Node.js, PHP, Python, Go).
* **База данных:** Реляционная (PostgreSQL, MySQL) или NoSQL (MongoDB).
* **Сторонние сервисы:**
    * **Firebase Cloud Messaging:** для Push-уведомлений.
    * **Яндекс.Метрика:** для веб-аналитики.

---

#### **3. Структура страниц и роутинг**

1.  **Страница-превью статьи (`/{category}/{article-slug}/`)**
    * **Описание:** Отображает "превью": заголовок, изображение и кнопку "Читать далее". В боковой колонке (на десктопе) подгружаются "горячие новости".
    * **Функциональность:**
        * При клике на область превью, в новой вкладке открывается полная версия статьи (`/full/`).
        * Текущая вкладка **трансформируется в страницу-список** (`/list.html`), очищая контент статьи и динамически загружая ленту новостей. Этот переход реализуется через JS без перезагрузки страницы, используя `history.pushState`.
        * На этой странице используется особый тип запроса для ленты (`teaserType = 'news_teasers'`).

2.  **Страница полной статьи (`/{category}/{article-slug}/full/`)**
    * **Описание:** Отображает полный текст статьи, мета-информацию (дата, просмотры).
    * **Функциональность:**
        * В тело статьи динамически вставляются тизерные блоки в зависимости от количества абзацев (тегов `<br />`). Логика их вставки и выбора типа (`inicx2`, `incontent`, `mobicno`, `pcicno`) описана в функции `getInContentBlocks`.
        * Высота боковой колонки с новостями (`#load_aside`) рассчитывается динамически в зависимости от высоты основного контента статьи, чтобы обеспечить гармоничное заполнение.

3.  **Страница-список (`/list.html`)**
    * **Описание:** Основная страница, отображающая бесконечную ленту новостей.
    * **Функциональность:** При инициализации загружает два типа блоков: 12 основных новостей (`'top'`) и 4 дополнительных (`'all4'`) для десктопной версии.

4.  **Страница категории (`/{category-slug}/`)**
    * **Описание:** Лента новостей, отфильтрованная по ID категории (`catID`).
    * **Функциональность:** Запрашивает новости с типом `'last'`.

---

#### **4. Общие компоненты**

1.  **Header (Шапка сайта):** Содержит стилизованный логотип "WorldWave".
2.  **Footer (Подвал сайта):** Содержит логотип, копирайт (© 2025), возрастное ограничение (16+) и служебный хэш.
3.  **Элемент новости:** Ключевой компонент с множеством шаблонов:
    * **`all` (`item-size__l`):** Изображение 234px, под ним заголовок.
    * **`all4` (`item-size__s`):** Горизонтальный блок 483px, изображение 114x76px слева.
    * **`aside`:** Вертикальный блок для боковой колонки.
    * **`incontent`:** Горизонтальный блок с квадратным изображением 150x150px.
    * **`noimgic`:** Блок без изображения с акцентной рамкой слева (`border-left: solid var(--accent-color) 4px`).
    * **`redic`:** Блок "Материалы по теме" с фоном `#FFEFE5`.
    * **`topx2`, `inicx2`, `mobic`:** Групповые блоки, объединяющие несколько тизеров.

---

#### **5. Вёрстка, стили и адаптивность**

1.  **Шрифты:** Подключить **Lato**, **Roboto**, **LTAvocado-Bold**.
2.  **Стили:** Использовать CSS-переменные для цветов (`--accent-color: #1e90ff`).
3.  **Адаптивность:**
    * **Десктоп (`> 980px`):**
        * Основной контейнер имеет ширину 980px.
        * На странице статьи двухколоночная структура: контент (620px) и сайдбар (268px).
        * Лента новостей использует сложные шаблоны, включая `all` (4 в ряд) и `all4`.
    * **Планшет (`600px - 979px`):**
        * Сайдбар скрывается.
        * Лента перестраивается, например, элементы `item-size__l` занимают по 50% ширины.
        * Количество загружаемых элементов меняется (например, 10 вместо 12 для `load_main`).
    * **Мобильные устройства (`< 599px`):**
        * Одноколоночная вёрстка.
        * Скрываются многие элементы (`item-size__s`, `item__red-block`, `aside-container`).
        * Количество загружаемых элементов минимально (например, 6 для `load_main`).

---

#### **6. Функциональные требования**

1.  **Динамическая загрузка контента (`load.raw.js`)**
    * **Инициализация:** Функция `loadInit` принимает правила, где количество элементов зависит от ширины экрана, используя функцию `mW(min, max)`. Например: `mW(0, 599) * 6 + mW(600, 979) * 10 + mW(980) * 12`.
    * **Бесконечная прокрутка:** Функция `startScroll` активируется при достижении низа страницы (с отступом `scrollSpace = 200`) и подгружает новые блоки согласно правилам, определённым в `scrollScheme`.
    * **Блокировка рендеринга:** Переменная `renderLock` предотвращает одновременные запросы к API.
    * **Параметры URL:** Скрипт может читать `dev_geo` и `dev_dev` из URL и передавать их в API-запросе.

2.  **Система Push-уведомлений (`fcm.js`)**
    * **Конфигурация Firebase:** Используются статические ключи и ID проекта, указанные в переменных `L` (конфиг) и `We` (VAPID ключ).
    * **Уникальный ID устройства:** Перед регистрацией токена создается или получается из `localStorage` уникальный ID устройства (`d-id`) через API-эндпоинт `/api/v1/device/get-id`.
    * **Процесс подписки:**
        1.  Регистрируется Service Worker (`/firebase-messaging-sw.js` со scope `/firebase-cloud-messaging-push-scope`).
        2.  Запрашивается разрешение на уведомления. При отказе показывается кастомная подсказка.
        3.  Получается FCM-токен. Скрипт делает до 20 попыток с интервалом в 3 секунды, если токен не получен сразу.
        4.  Токен вместе с `d-id` отправляется на эндпоинт `/api/v1/device/register`.
    * **Обработка Push:** Service Worker обрабатывает события `push` (показ уведомления) и `notificationclick` (открытие `actionUrl`). Статистика отправляется на эндпоинты `/api/v1/event/...`.

3.  **Обработка кликов (Click Hijacking)**
    * **Глобальный обработчик:** Функция `onClick` (в `list.html` и др.) переназначает клики на всех ссылках, не имеющих класс `.direct`.
    * **Логика перенаправления:**
        1.  Отменяется стандартное событие (`event.preventDefault()`).
        2.  URL из `href` открывается в новой вкладке (`_blank`).
        3.  **Текущая вкладка** перезагружается на URL, указанный в переменной `bg` (например, `"/list.html"` или `"/market.html"`). Это ключевая механика для удержания пользователя на сайте.

---

#### **7. Требования к серверной части (API)**

1.  **`POST /qaz.html`**
    * **Назначение:** Основной эндпоинт для получения новостей.
    * **Входные параметры (тело запроса):**
        * `request`: Объект вида `{"top": 16, "last": 12}`.
        * `b`: Объект с детализацией по блокам, например `{"all:0": 12, "all4:0": 4}`.
        * `after`: Объект со смещениями для пагинации, `{"top": 16}`.
        * `id` (number): ID текущей новости для контекстной загрузки.
        * `catId` (number): ID категории для фильтрации.
    * **Ответ:** JSON вида `{"top": {"all:0": [...], "all4:0": [...]}}`, где `[...]` — массив объектов новостей.

2.  **`POST /api/v1/device/get-id`:** Получение ID устройства.
3.  **`POST /api/v1/device/register`:** Регистрация FCM-токена.
4.  **`POST /api/v1/event/{eventType}`:** Трекинг событий `delivered`, `displayed`, `clicked` для push-уведомлений.
5.  **`GET /api/v1/sw/texts/<lang>`:** Получение локализованных текстов для UI push-уведомлений.

---

#### **8. Дополнительные требования**

* **SEO:** Генерация `og:` мета-тегов и `rel="canonical"` на сервере для всех страниц.
* **Изображения:** Реализовать поддержку WebP. В `load.raw.js` есть логика для замены `.jpg` на `.webp` в URL изображений.
* **Мета-данные для трекинга:** В HTML присутствует мета-тег `custom:utms`, который содержит параметры для аналитики. Эти данные должны генерироваться на бэкенде.
* **Валюты:** На странице статьи есть статичный блок с курсами валют. В ТЗ можно предусмотреть его динамическое обновление через отдельный API.