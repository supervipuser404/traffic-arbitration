{% extends "layout.html" %}

{#
  Этот блок определяет заголовок страницы.
  Если категория передана из main.py, мы показываем ее,
  иначе показываем "Главная".
#}
{% block title %}
    {% if category %}
        Категория: {{ category }}
    {% else %}
        Главная страница
    {% endif %}
    :: {{ config.company_name }}
{% endblock %}

{#
  Этот блок вставляет CSS-стили прямо в <head> страницы.
  Они нужны для работы нашей новой сетки тизеров.
#}
{% block head %}
    {{ super() }}
    <style>
        /* --- Стили Сетки --- */
        .main-container {
            /* Ограничиваем максимальную ширину для 4 колонок */
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }

        .feed-container {
            display: grid;

            /* CSS-переменная для управления колонками */
            grid-template-columns: repeat(var(--feed-columns, 1), 1fr);
            gap: 20px;
        }

        /* --- Стили Тизера (Карточка) --- */

        .teaser-widget {
            background-color: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            text-decoration: none;
            color: #333;
            display: flex;
            flex-direction: column;
        }

        .teaser-widget:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .teaser-image-wrapper {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* Соотношение сторон 16:9 */
            background-color: #f0f0f0;
        }

        .teaser-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .teaser-content {
            padding: 16px;
            flex-grow: 1;
        }

        .teaser-title {
            font-size: 1.1rem;
            font-weight: 700;
            line-height: 1.4;
            margin: 0 0 8px 0;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 2.8em; /* 1.4 * 2 (для 2х строк) */
        }

        .teaser-text {
            font-size: 0.9rem;
            color: #555;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            margin: 0;
        }

        /* --- Заглушка для загрузки --- */
        .loading-placeholder {
            min-height: 250px;
            background: #f9f9f9;
            border-radius: 12px;
            display: flex;
            /* Исправлено: align-items */
            align-items: center;
            justify-content: center;
            color: #ccc;
        }
    </style>
{% endblock %}

{#
  Этот блок заменяет основной контент страницы.
#}
{% block content %}
<main class="main-container">

    {% if category %}
        <h1>Категория: {{ category }}</h1>
    {% else %}
        <h1>Главная</h1>
    {% endif %}

    <!-- Это контейнер для нашей "бесконечной" ленты -->
    <div id="teaser-feed" class="feed-container">
        <!--
          JavaScript будет заполнять этот блок
          элементами <div class="teaser-widget">...</div>
        -->
    </div>

</main>
{% endblock %}

{#
  Этот блок вставляет JavaScript в конец <body>.
#}
{% block scripts %}
    {{ super() }} {# Загружает jQuery и fcm.js из layout.html #}

    <script>
        $(document).ready(function() {

            // --- Глобальные переменные ---
            const feed = $('#teaser-feed');
            let currentPage = 0; // Отслеживаем текущую "страницу" (ряд) ленты
            let isLoading = false; // Флаг, чтобы не загружать данные дважды

            const currentCategory = {{ category | tojson | safe }};

            // --- 1. Определение сетки ---

            function getGridColumns() {
                const width = window.innerWidth;
                if (width > 1200) return 4;
                if (width > 900) return 3;
                if (width > 600) return 2;
                return 1;
            }

            function generateWidgetNames(pageIndex, columns) {
                const widgets = {};
                for (let i = 0; i < columns; i++) {
                    const widgetName = `l${i.toString(16)}${pageIndex.toString(16).padStart(2, '0')}`;
                    widgets[widgetName] = 1;
                }
                return widgets;
            }

            // --- 2. Запрос и Рендеринг Данных ---

            function placeholderImage(text) {
                return `https://placehold.co/400x225/E8E8E8/999?text=${encodeURIComponent(text)}`;
            }

            /**
             * Рендерит тизеры в контейнер
             * @param {object} widgetsData - Ответ от API (e.g. {"l00": [teaser], ...})
             * @param {number} pageIndex - Индекс ряда, который мы рендерим
             */
            function renderTeasers(widgetsData, pageIndex) {
                const columns = getGridColumns();

                // Мы должны рендерить в правильном порядке (l0x, l1x, l2x, l3x)
                for (let i = 0; i < columns; i++) {
                    // Используем `pageIndex`, который мы *ожидаем* отрендерить
                    const widgetName = `l${i.toString(16)}${pageIndex.toString(16).padStart(2, '0')}`;

                    if (widgetsData[widgetName] && widgetsData[widgetName].length > 0) {
                        const teaser = widgetsData[widgetName][0];
                        const imageUrl = teaser.image ? teaser.image : placeholderImage(widgetName);

                        const teaserHtml = `
                            <a class="teaser-widget" id="${widgetName}" href="${teaser.url}" target="_blank">
                                <div class="teaser-image-wrapper">
                                    <img class="teaser-image"
                                         src="${imageUrl}"
                                         alt="${teaser.title || 'Teaser'}"
                                         onerror="this.src='${placeholderImage('Error')}'">
                                </div>
                                <div class="teaser-content">
                                    <h3 class="teaser-title">${teaser.title || 'Заголовок тизера'}</h3>
                                    <p class="teaser-text">${teaser.text || 'Описание тизера...'}</p>
                                </div>
                            </a>
                        `;
                        feed.append(teaserHtml);
                    } else {
                         const placeholderHtml = `
                            <div class="teaser-widget loading-placeholder" id="${widgetName}">
                                <span>(empty: ${widgetName})</span>
                            </div>
                        `;
                        feed.append(placeholderHtml);
                    }
                }
            }

            // --- ИЗМЕНЕНИЕ ЛОГИКИ ЗАГРУЗКИ ---
            /**
             * Проверяет, заполнена ли страница,
             * и если нет, загружает еще.
             */
            function checkAndLoadMore() {
                if (isLoading) return;

                // Используем document.documentElement.scrollHeight для
                // получения полной высоты контента
                const scrollHeight = document.documentElement.scrollHeight;
                const windowHeight = $(window).height();

                // Если нет полосы прокрутки (контент короче окна)
                if (scrollHeight <= windowHeight) {
                    console.log("Контент не заполняет экран, загружаем еще...", currentPage);
                    fetchTeasers(currentPage);
                }
            }


            /**
             * Основная функция запроса тизеров
             * @param {number} pageIndex - Индекс ряда для загрузки
             */
            function fetchTeasers(pageIndex) {
                if (isLoading) return;
                isLoading = true;

                console.log(`Запрос ряда ${pageIndex}`);

                const columns = getGridColumns();
                const widgetsToLoad = generateWidgetNames(pageIndex, columns);

                // Добавляем плейсхолдеры с уникальными ID
                const placeholderIds = [];
                for (let i = 0; i < columns; i++) {
                    const id = `placeholder-${pageIndex}-${i}`;
                    placeholderIds.push(id);
                    feed.append(`<div class="loading-placeholder" id="${id}">...</div>`);
                }

                const requestBody = {
                    uid: "user-123", // Заглушка
                    ip: "127.0.0.1", // Заглушка
                    ua: navigator.userAgent,
                    url: window.location.href,
                    loc: "ru",
                    w: window.innerWidth,
                    h: window.innerHeight,
                    widgets: widgetsToLoad
                    // В будущем тут будет и 'category': currentCategory
                };

                $.ajax({
                    url: "/etc",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(requestBody),
                    success: function(response) {
                        // Убираем *только* те плейсхолдеры,
                        // которые мы добавили для *этого* запроса
                        placeholderIds.forEach(id => $(`#${id}`).remove());

                        if (response.widgets) {
                            // Передаем pageIndex в renderTeasers,
                            // чтобы он знал, какие имена виджетов
                            // ожидать
                            renderTeasers(response.widgets, pageIndex);
                            currentPage = pageIndex + 1; // Увеличиваем номер "страницы"
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("Ошибка при загрузке тизеров:", error);
                        placeholderIds.forEach(id => $(`#${id}`).remove());
                    },
                    complete: function() {
                        isLoading = false;

                        // --- ИЗМЕНЕНИЕ ---
                        // После *каждой* загрузки проверяем,
                        // нужно ли загрузить еще (если экран не полон).
                        checkAndLoadMore();
                    }
                });
            }

            // --- 3. Инициализация и Обработчики ---

            /**
             * Обновляет CSS-переменную для сетки и сбрасывает ленту
             */
            function updateGrid() {
                const cols = getGridColumns();
                console.log(`Обновление сетки: ${cols} колонок (ширина ${window.innerWidth}px)`);
                document.documentElement.style.setProperty('--feed-columns', cols.toString());

                feed.empty();
                currentPage = 0;

                // --- ИЗМЕНЕНИЕ ---
                // Загружаем *только* первый ряд.
                // Остальное сделает checkAndLoadMore()
                // или скролл, если полоса прокрутки появится сразу.
                fetchTeasers(0);
            }

            // "Бесконечная" прокрутка
            $(window).on('scroll', function() {
                const scrollHeight = document.documentElement.scrollHeight;
                const scrollTop = $(window).scrollTop();
                const windowHeight = $(window).height();

                // Загружаем за 500px до конца
                if (scrollTop + windowHeight >= scrollHeight - 500) {
                    if (!isLoading) {
                        console.log("Загрузка (скролл) следующего ряда...", currentPage);
                        fetchTeasers(currentPage);
                    }
                }
            });

            // Обработчик изменения размера окна (с задержкой)
            let resizeTimer;
            $(window).on('resize', function() {
                clearTimeout(resizeTimer);
                // Перестраиваем всю сетку
                resizeTimer = setTimeout(updateGrid, 300);
            });

            // --- Первый запуск ---
            updateGrid(); // Устанавливаем сетку и загружаем первый ряд

        });
    </script>
{% endblock %}