# Документация админ-панели Traffic Arbitration

## Оглавление

1. [Обзор](#обзор)
2. [Быстрый старт](#быстрый-старт)
3. [Руководство пользователя](#руководство-пользователя)
4. [Техническая архитектура](#техническая-архитектура)
5. [API Reference](#api-reference)
6. [Решение проблем](#решение-проблем)

---

## Обзор

Админ-панель Traffic Arbitration — это современная веб-система управления контентом, предназначенная для полного контроля над процессом создания, обработки и публикации контента. Система обеспечивает комплексное управление контент-пайплайном от источников до финальных статей.

### Основные возможности

- **Управление статьями**: Создание, редактирование и публикация контента с поддержкой локализации
- **Контент-пайплайн**: Автоматизированный процесс сбора и обработки данных из внешних источников  
- **Медиа-библиотека**: Управление изображениями и файлами с оптимизацией и метаданными
- **Таксономия**: Настройка категорий, географических меток, тегов и локалей
- **Дашборд**: Мониторинг системы и аналитика производительности

### Ключевые преимущества

- **Модульная архитектура**: Разделение функциональности на независимые роутеры
- **Многоязычность**: Поддержка локализации контента и интерфейса
- **SEO-оптимизация**: Автоматическая генерация URL-slug из заголовков
- **Реальное время**: Автообновление дашборда и мониторинг процессов
- **Безопасность**: Аутентификация и защита от CSRF-атак

---

## Быстрый старт

### Системные требования

- Python 3.8+
- PostgreSQL 12+
- 4 GB RAM минимум
- 1 GB свободного места на диске

### Запуск админ-панели

```bash
# Переход в директорию проекта
cd /home/andrey/Projects/Work/traffic-arbitration/python

# Запуск через Poetry
poetry run uvicorn traffic_arbitration.admin.main:app --host 0.0.0.0 --port 8081

# Или в фоновом режиме
poetry run uvicorn traffic_arbitration.admin.main:app --host 0.0.0.0 --port 8081 &
```

### Доступ к системе

1. Откройте браузер и перейдите по адресу: `http://localhost:8081/admin`
2. При первом запуске будет доступна аутентификация через Basic Auth
3. Главная страница отобразит дашборд с основной статистикой

### Первые шаги

1. **Проверьте дашборд** - убедитесь, что все сервисы работают
2. **Настройте источники контента** в разделе Pipeline → Sources  
3. **Создайте базовые категории** в разделе Settings → Categories
4. **Загрузите медиа-файлы** в раздел Media → Upload

---

## Руководство пользователя

### Главная страница (Dashboard)

Главная страница админ-панели предоставляет полный обзор системы через интерактивный дашборд.

#### Статистические карточки

- **Articles**: Общее количество статей и количество активных
- **Content Sources**: Источники контента с указанием активных
- **Media Files**: Загруженные медиа-файлы и категории
- **External Articles**: Внешние статьи с информацией об обработке

#### Статус контент-пайплайна

- **External Links**: Ссылки на внешние источники и статус обработки
- **Article Previews**: Предварительные просмотры статей
- **Processing Progress**: Визуальное отображение прогресса обработки

#### Быстрые действия

- Создание новой статьи
- Добавление источника контента  
- Загрузка медиа-файлов
- Просмотр предварительных просмотров

### Раздел: Articles (Статьи)

Управление контентом - центральная функция админ-панели.

#### Список статей (`/admin/articles`)

**Функции:**
- Просмотр всех статей с пагинацией (50 элементов на страницу)
- Фильтрация по статусу, дате, локали
- Поиск по заголовку и тексту
- Массовые операции (удаление, активация/деактивация)

**Отображаемая информация:**
- ID статьи и заголовок
- Статус (активна/неактивна)
- Локаль и связанные категории
- Дата создания и последнего обновления
- URL-slug для SEO

**Действия:**
- Просмотр статьи
- Редактирование
- Создание дочерней статьи (иерархия)
- Сравнение с источником
- Удаление (с проверкой связей)

#### Создание статьи (`/admin/articles/create`)

**Обязательные поля:**
- **Title**: Заголовок статьи (генерирует URL-slug)
- **Text**: Основной контент статьи  
- **Locale**: Языковая версия из настроенных локалей

**Дополнительные параметры:**
- **Slug**: URL-идентификатор (автогенерация из заголовка)
- **Categories**: Привязка к категориям (множественный выбор)
- **Geo**: Географические метки (таргетинг)
- **Tags**: Дополнительные теги
- **Image**: Привязка изображения из медиа-библиотеки
- **Parent**: Создание иерархии статей
- **Source Date**: Дата источника контента

**Валидация:**
- Проверка уникальности slug
- Валидация локали и связанных данных
- Автоматическое сохранение изменений

#### Редактирование статьи (`/admin/articles/{id}/edit`)

Аналогично созданию, с предзаполненными данными существующей статьи.

#### Сравнение статей (`/admin/articles/{id}/compare`)

Позволяет сравнить созданную статью с исходным внешним контентом для контроля качества обработки.

### Раздел: Pipeline (Контент-пайплайн)

Автоматизированный процесс сбора, обработки и подготовки контента.

#### Источники контента (`/admin/pipeline/sources`)

**Управление источниками:**
- Просмотр списка всех источников
- Добавление новых источников с конфигурацией
- Редактирование параметров источника
- Активация/деактивация источников
- Удаление источников (с проверкой связей)

**Параметры источника:**
- **Name**: Название источника
- **Source Handler**: Python-класс обработчика
- **Domain**: Основной домен источника
- **Aliases**: Дополнительные домены
- **Description**: Описание источника
- **Status**: Активен/неактивен

#### Предварительные просмотры (`/admin/pipeline/previews`)

**Функции просмотра:**
- Отображение найденных заголовков и изображений
- Статус обработки каждого превью
- Запуск процесса скачивания полной статьи
- Фильтрация по источнику и статусу

#### Внешние статьи (`/admin/pipeline/external-articles`)

**Обработка контента:**
- Просмотр скачанных статей из внешних источников
- Статус обработки (обработано/необработано)
- Конвертация во внутренние статьи
- Сравнение с оригинальным источником

### Раздел: Media (Медиа)

Управление медиа-библиотекой с поддержкой изображений и файлов.

#### Галерея (`/admin/media/gallery`)

**Возможности галереи:**
- Просмотр всех загруженных медиа-файлов
- Оптимизированный просмотр (20 элементов на страницу)
- Фильтрация по категориям и тегам
- Обновление метаданных изображений

**Отображаемая информация:**
- Предварительный просмотр изображения
- Название файла и расширение
- Размеры (ширина x высота)
- Размер файла
- Дата загрузки
- Связанные категории и теги

#### Загрузка файлов (`/admin/media/upload`)

**Поддерживаемые форматы:**
- Изображения: JPG, PNG, GIF, WebP
- Максимальный размер: 10MB
- Автоматическое извлечение метаданных

**Процесс загрузки:**
1. Выбор файла через интерфейс drag-and-drop
2. Автоматическое извлечение размеров и метаданных
3. Сохранение в базе данных с оптимизацией
4. Присвоение уникального URL для доступа

### Раздел: Settings (Настройки)

Настройка таксономии и конфигурации системы.

#### Категории (`/admin/settings/categories`)

**Управление категориями:**
- Создание иерархической структуры категорий
- Назначение локализованных названий
- Связь категорий со статьями и медиа

**Поля категории:**
- **Code**: Уникальный код категории (slug)
- **Description**: Описание категории
- **Labels**: Локализованные названия для разных языков

#### Geo-метки (`/admin/settings/geo`)

**Географическая классификация:**
- Создание географических меток
- Локализованные названия регионов
- Связь с таргетированным контентом

#### Теги (`/admin/settings/tags`)

**Свободная маркировка:**
- Создание тегов для контента
- Связь с статьями и медиа
- Автодополнение при вводе

#### Локали (`/admin/settings/locales`)

**Языковые версии:**
- Управление поддерживаемыми языками
- Коды локалей (ru, en, de и т.д.)
- Привязка к контенту

#### Источники контента (`/admin/settings/content-sources`)

Расширенное управление источниками с детальной конфигурацией и статистикой.

---

## Техническая архитектура

### Общая архитектура

Админ-панель построена на основе **FastAPI** с модульной архитектурой роутеров, обеспечивающей масштабируемость и поддерживаемость кода.

#### Структура проекта

```
python/traffic_arbitration/admin/
├── main.py                 # Главное приложение FastAPI
├── dependencies.py         # Зависимости (аутентификация, БД)
├── routers/               # Модульные роутеры
│   ├── articles.py       # Управление статьями
│   ├── pipeline.py       # Контент-пайплайн
│   ├── media.py          # Медиа-библиотека
│   └── settings.py       # Настройки и таксономия
├── schemas.py            # Pydantic схемы для валидации
├── static/               # Статические файлы
│   ├── css/             # Стили
│   └── js/              # JavaScript
└── templates/           # Jinja2 шаблоны
    ├── layouts.html     # Базовый макет
    ├── admin/          # Дашборд
    ├── articles/       # Статьи
    ├── pipeline/       # Пайплайн
    ├── media/          # Медиа
    └── settings/       # Настройки
```

### Модели данных

#### Основные сущности

**Article** - статьи:
- Поддержка иерархии (parent_id)
- SEO-оптимизация (slug)
- Многоязычность (locale_id)
- Связи с категориями, тегами, гео

**ExternalArticle** - внешние статьи:
- Связь с источником через link_id
- Статус обработки
- Автоматическая генерация статей

**VisualContent** - медиа-контент:
- Хранение бинарных данных
- Метаданные (размеры, формат)
- Связи с категориями и тегами

**Таксономия**:
- Category/CategoryLabel - категории с локализацией
- Geo/GeoLabel - географические метки
- Tag - теги
- Locale - языковые версии

#### Связи Many-to-Many

Система использует промежуточные таблицы для связи многие-ко-многим:
- ArticleCategory - статьи ↔ категории
- ArticleTag - статьи ↔ теги  
- ArticleGeo - статьи ↔ гео-метки
- VisualContentTag - медиа ↔ теги

### API роутеры

#### Articles Router (`/admin/articles`)

```python
GET  /                    # Список статей с фильтрацией
GET  /create              # Форма создания статьи
POST /create              # Создание статьи
GET  /{id}/edit           # Форма редактирования
POST /{id}/edit           # Обновление статьи
POST /{id}/delete         # Удаление статьи
GET  /{id}/compare        # Сравнение с источником
```

#### Pipeline Router (`/admin/pipeline`)

```python
GET  /sources                    # Список источников
POST /sources                    # Создание источника
GET  /sources/{id}/edit          # Редактирование источника
POST /sources/{id}/edit          # Обновление источника
POST /sources/{id}/toggle        # Переключение активности
POST /sources/{id}/delete        # Удаление источника
GET  /previews                   # Список превью
GET  /external-articles          # Список внешних статей
```

#### Media Router (`/admin/media`)

```python
GET  /gallery                    # Галерея медиа
GET  /upload                     # Форма загрузки
POST /upload                     # Загрузка файла
POST /{id}/delete                # Удаление медиа
GET  /{id}/metadata              # Получение метаданных
```

#### Settings Router (`/admin/settings`)

```python
GET  /categories                 # Список категорий
POST /categories/create          # Создание категории
POST /categories/{id}/edit       # Редактирование категории
POST /categories/{id}/delete     # Удаление категории
GET  /geo                        # Geo-метки
POST /geo/create                 # Создание geo
POST /geo/{id}/delete            # Удаление geo
GET  /tags                       # Список тегов
POST /tags/create                # Создание тега
POST /tags/{id}/delete           # Удаление тега
GET  /locales                    # Список локалей
POST /locales/create             # Создание локали
POST /locales/{id}/delete        # Удаление локали
```

### Шаблонизация

#### Jinja2 шаблоны

Используется наследование шаблонов с базовым макетом `layouts.html`:

**Базовый макет включает:**
- Навигационное меню с выпадающими списками
- Хлебные крошки для навигации
- Система уведомлений
- Подвал с информацией о системе
- JavaScript для интерактивности

#### Компоненты интерфейса

**Адаптивный дизайн:**
- Bootstrap 5.3 для UI-компонентов
- Bootstrap Icons для иконографии
- Кастомные CSS-стили в admin.css
- Мобильно-ориентированный дизайн

**Интерактивность:**
- Автообновление дашборда каждые 5 минут
- Drag-and-drop для загрузки файлов
- AJAX для динамических обновлений
- Подтверждение критических операций

### Безопасность

#### Аутентификация

```python
async def verify_credentials(username: str, password: str):
    # Проверка учетных данных
    # Возвращает username при успехе
```

#### Защита данных

- **CSRF Protection**: Защита форм через встроенные механизмы FastAPI
- **Input Validation**: Pydantic схемы для валидации всех входных данных
- **SQL Injection**: ORM SQLAlchemy предотвращает SQL-инъекции
- **File Upload**: Ограничения размера и типа файлов

#### Валидация данных

**Примеры валидации:**
```python
@validator('slug')
def validate_slug(cls, v):
    if not re.match(r'^[a-z0-9-]+$', v):
        raise ValueError('Slug должен содержать только строчные буквы, цифры и дефисы')
    return v

@validator('file_size')
def validate_file_size(cls, v):
    if len(v) > 10 * 1024 * 1024:  # 10MB
        raise ValueError('Размер файла не должен превышать 10MB')
    return v
```

---

## API Reference

### Основные эндпоинты

#### Dashboard

**GET** `/admin` - Главная страница дашборда

**Ответ:**
```json
{
  "stats": {
    "total_articles": 150,
    "active_articles": 142,
    "content_sources": 5,
    "active_sources": 4,
    "visual_content": 320,
    "external_articles": 89,
    "processed_articles": 67
  },
  "recent_activity": [...],
  "current_time": "2025-12-02 19:26 UTC"
}
```

#### Articles API

**GET** `/admin/articles` - Получение списка статей

**Параметры:**
- `page` (int): Номер страницы (по умолчанию: 1)
- `per_page` (int): Элементов на страницу (по умолчанию: 50)
- `search` (str): Поиск по заголовку и тексту
- `status` (str): Фильтр по статусу ('active', 'inactive')
- `locale` (int): ID локали для фильтрации

**POST** `/admin/articles/create` - Создание статьи

**Форма данных:**
```json
{
  "title": "Заголовок статьи",
  "text": "Текст статьи",
  "slug": "url-slug-article",
  "locale_id": 1,
  "category_ids": [1, 2],
  "tag_ids": [3, 4],
  "geo_ids": [5],
  "image_id": 15,
  "is_active": true
}
```

#### Media API

**GET** `/admin/media/gallery` - Получение галереи

**POST** `/admin/media/upload` - Загрузка файла

**Параметры формы:**
- `file`: Загружаемый файл (максимум 10MB)
- `name` (опционально): Название файла
- `category_ids` (опционально): ID категорий через запятую
- `tag_ids` (опционально): ID тегов через запятую

#### Settings API

**GET** `/admin/settings/categories` - Получение категорий

**POST** `/admin/settings/categories/create` - Создание категории

**Форма данных:**
```json
{
  "code": "technology",
  "description": "Статьи о технологиях",
  "labels": [
    {"locale": "ru", "label": "Технологии"},
    {"locale": "en", "label": "Technology"}
  ]
}
```

### Коды ответов

- **200** - Успешное выполнение
- **201** - Ресурс создан
- **400** - Ошибка валидации данных
- **404** - Ресурс не найден
- **500** - Внутренняя ошибка сервера

### Форматы ошибок

```json
{
  "errors": [
    "Код категории обязателен",
    "Некорректный формат slug"
  ]
}
```

---

## Решение проблем

### Часто встречающиеся проблемы

#### 1. Ошибка подключения к базе данных

**Симптомы:**
- `sqlalchemy.exc.DisconnectionError`
- `could not connect to server`

**Решение:**
```bash
# Проверка статуса PostgreSQL
sudo systemctl status postgresql

# Перезапуск PostgreSQL
sudo systemctl restart postgresql

# Проверка настроек подключения
cat /etc/postgresql/*/main/pg_hba.conf
```

#### 2. Проблемы с загрузкой файлов

**Симптомы:**
- `413 Request Entity Too Large`
- Файлы не загружаются

**Решение:**
```python
# В main.py добавить ограничения
app = FastAPI()
app.add_middleware(
    SomeMiddleware,
    max_file_size=10 * 1024 * 1024  # 10MB
)
```

#### 3. Ошибки валидации данных

**Симптомы:**
- `ValidationError` при создании статей
- Неправильные slug

**Решение:**
- Проверьте формат slug: только строчные буквы, цифры и дефисы
- Убедитесь в уникальности slug в базе данных
- Проверьте наличие связанных записей при удалении

#### 4. Проблемы с отображением интерфейса

**Симптомы:**
- CSS не загружается
- JavaScript ошибки

**Решение:**
```bash
# Проверка статических файлов
ls -la python/traffic_arbitration/admin/static/

# Перезапуск сервера с очисткой кеша
curl -X GET http://localhost:8081/static/css/admin.css
```

### Отладка и логирование

#### Включение подробного логирования

```python
# В main.py
import logging
logging.basicConfig(level=logging.DEBUG)

# В зависимостях
logger = logging.getLogger(__name__)
logger.info("Debug message")
```

#### Проверка состояния системы

```python
# Функция проверки здоровья системы
@app.get("/admin/health")
async def health_check(db: Session = Depends(get_db)):
    try:
        # Проверка подключения к БД
        db.execute("SELECT 1")
        
        # Проверка основных таблиц
        tables = ['articles', 'content_sources', 'visual_content']
        for table in tables:
            result = db.execute(f"SELECT COUNT(*) FROM {table}")
            
        return {"status": "healthy", "timestamp": datetime.utcnow()}
    except Exception as e:
        return {"status": "unhealthy", "error": str(e)}
```

### Производительность

#### Оптимизация запросов к БД

- Использование индексов для частых запросов
- Пагинация для больших списков
- Lazy loading для связей
- Кэширование статистических данных

#### Мониторинг производительности

```python
import time
from functools import wraps

def measure_time(func):
    @wraps(func)
    async def wrapper(*args, **kwargs):
        start = time.time()
        result = await func(*args, **kwargs)
        end = time.time()
        logger.info(f"{func.__name__} took {end - start:.2f} seconds")
        return result
    return wrapper

@measure_time
async def get_dashboard_stats(db: Session):
    # Функция получения статистики
    pass
```

### Сброс и восстановление

#### Сброс базы данных

```bash
# Полный сброс (ОСТОРОЖНО!)
cd python
poetry run python -c "
from traffic_arbitration.db.connection import engine
from traffic_arbitration.models import Base
Base.metadata.drop_all(engine)
Base.metadata.create_all(engine)
"
```

#### Восстановление из резервной копии

```bash
# Создание резервной копии
pg_dump -U username -h localhost traffic_arbitration > backup.sql

# Восстановление из резервной копии
psql -U username -h localhost traffic_arbitration < backup.sql
```

---

## Заключение

Админ-панель Traffic Arbitration представляет собой современную, масштабируемую систему управления контентом с полной поддержкой многоязычности, автоматизированного контент-пайплайна и SEO-оптимизации. 

### Основные достижения проекта

✅ **Модульная архитектура** - Разделение функциональности на независимые компоненты  
✅ **Полная функциональность** - Все разделы работают без критических ошибок  
✅ **Современный интерфейс** - Адаптивный дизайн на Bootstrap 5.3  
✅ **Безопасность** - Защита от CSRF, SQL-инъекций и валидация данных  
✅ **Производительность** - Оптимизированные запросы и пагинация  
✅ **Документация** - Полное описание для пользователей и разработчиков  

### Рекомендации по использованию

1. **Регулярные резервные копии** - Настройте автоматическое резервное копирование БД
2. **Мониторинг производительности** - Следите за временем отклика и использованием ресурсов
3. **Обновления безопасности** - Регулярно обновляйте зависимости и компоненты
4. **Обучение пользователей** - Используйте эту документацию для обучения команды

Система готова к продуктивному использованию и может быть легко расширена дополнительным функционалом благодаря модульной архитектуре.

---

*Документация подготовлена: 2 декабря 2025 г.*  
*Версия системы: 1.0.0*  
*Контактная информация: команда разработки Traffic Arbitration*